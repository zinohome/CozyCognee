# Caddy 反向代理配置
# 统一后端服务，避免 CORS 问题
# 根据 nginx.conf 配置生成，实现相同的功能

:80

# 客户端请求体大小限制
request_body {
    max_size 100MB
}

# ==================== CORS 配置 ====================
# 统一添加 CORS 头，允许前端跨域访问
# 动态设置 CORS Origin（支持 localhost、127.0.0.1、192.168.x.x）

# 处理 OPTIONS 预检请求（CORS 预检）
@options {
    method OPTIONS
}
handle @options {
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
        Access-Control-Max-Age "1728000"
    }
    respond 204
}

# ==================== Cognee 主 API ====================
# 路径: /api/* -> cognee:8000/api/* (保留完整路径，因为后端路由是 /api/v1/*)

# FastAPI 文档路径映射：/api/docs -> /docs (直接代理，不重定向)
handle /api/docs {
    rewrite * /docs
    reverse_proxy cognee:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# FastAPI ReDoc 路径映射：/api/redoc -> /redoc
handle /api/redoc {
    rewrite * /redoc
    reverse_proxy cognee:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# OpenAPI JSON 规范文件：/openapi.json -> cognee:8000/openapi.json
# Swagger UI 会从根路径请求 /openapi.json（当访问 /api/docs 时）
handle /openapi.json {
    reverse_proxy cognee:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# OpenAPI JSON 规范文件（通过 /api/openapi.json 访问）
handle /api/openapi.json {
    rewrite * /openapi.json
    reverse_proxy cognee:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# 正常路径：/api/* -> cognee:8000/api/* (包括 /api/v1/* 等)
handle /api/* {
    reverse_proxy cognee:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # WebSocket 支持
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
        
        # 超时设置
        transport http {
            dial_timeout 60s
            response_header_timeout 60s
        }
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# Cognee 健康检查
handle /health {
    reverse_proxy cognee:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# Cognee 详细健康检查
handle /health/detailed {
    reverse_proxy cognee:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# ==================== Cognee MCP API Mode ====================
# 路径: /mcp-api/* -> cognee-mcp-api:8000/* (去除 /mcp-api/ 前缀)
handle_path /mcp-api/* {
    reverse_proxy cognee-mcp-api:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
        
        # SSE 支持（Server-Sent Events）
        header_up Connection ""
        header_up Cache-Control "no-cache"
        
        # 超时设置（SSE 需要长连接）
        transport http {
            dial_timeout 300s
            response_header_timeout 300s
        }
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# MCP API 健康检查
handle /mcp-api/health {
    rewrite * /health
    reverse_proxy cognee-mcp-api:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# ==================== Cognee MCP Direct Mode ====================
# 路径: /mcp-direct/* -> cognee-mcp-direct:8000/* (去除 /mcp-direct/ 前缀)
handle_path /mcp-direct/* {
    reverse_proxy cognee-mcp-direct:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
        
        # SSE 支持（Server-Sent Events）
        header_up Connection ""
        header_up Cache-Control "no-cache"
        
        # 超时设置（SSE 需要长连接）
        transport http {
            dial_timeout 300s
            response_header_timeout 300s
        }
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# MCP Direct 健康检查
handle /mcp-direct/health {
    rewrite * /health
    reverse_proxy cognee-mcp-direct:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        
        # 隐藏后端返回的 CORS 头，避免重复
        header_down -Access-Control-Allow-Origin
        header_down -Access-Control-Allow-Methods
        header_down -Access-Control-Allow-Headers
        header_down -Access-Control-Allow-Credentials
    }
    
    # 添加 CORS 头
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
}

# ==================== 前端服务 ====================
# 路径: / -> cognee-frontend:3000
# 注意：这个 handle 必须在最后，因为 Caddy 按顺序匹配
# 精确匹配和前缀匹配（/api/, /mcp-api/）会优先于这个通用匹配
# 与 Nginx 的 location / 一致：使用通用匹配处理所有请求，包括 WebSocket

# Next.js WebSocket HMR 路径（/_next/webpack-hmr）
# 根据 Sentry 文章：Next.js 12+ 使用 WebSocket 进行 HMR
# 参考：https://sentry.io/answers/websocket-connection-to-ws-app-url-next-webpack-hmr-failed-websocket-is-closed-before-the-connection-is-established/
# Caddy 的 reverse_proxy 应该能够自动检测并处理 WebSocket 升级请求
# 我们只需要确保使用 HTTP/1.1 协议，并让 Caddy 自动传递所有必要的头
handle /_next/webpack-hmr* {
    reverse_proxy cognee-frontend:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Port {port}
        
        # 注意：不要手动设置 Upgrade 和 Connection 头
        # Caddy 的 reverse_proxy 会自动检测 WebSocket 升级请求并传递这些头
        # 手动设置可能会干扰自动检测机制
        
        # 使用 HTTP/1.1 协议（WebSocket 需要）
        transport http {
            versions 1.1
            dial_timeout 60s
            response_header_timeout 60s
        }
    }
}

# 处理所有其他前端请求（普通 HTTP 请求和页面）
handle {
    reverse_proxy cognee-frontend:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # Next.js 特定配置
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Port {port}
        
        # 超时设置
        transport http {
            dial_timeout 60s
            response_header_timeout 60s
        }
    }
}
