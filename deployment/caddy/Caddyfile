# Caddy 反向代理配置
# 统一后端服务，避免 CORS 问题
# Caddy 自动处理 HTTPS 和 CORS

:8080

# 客户端请求体大小限制
request_body {
    max_size 100MB
}

# ==================== CORS 配置 ====================
# 统一添加 CORS 头，允许前端跨域访问
# 注意：如果前端和后端都通过同一个反向代理访问（相同端口），则不需要 CORS
# 但如果前端在 3000 端口，API 在 8080 端口，则需要 CORS 头
# 处理 OPTIONS 预检请求
@options {
    method OPTIONS
}
handle @options {
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Allow-Credentials "true"
    }
    respond 204
}

# 为所有响应添加 CORS 头（除了 OPTIONS 请求）
header {
    Access-Control-Allow-Origin "*"
    Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Access-Control-Allow-Credentials "true"
}

# ==================== Cognee 主 API ====================
# 路径: /api/* -> cognee:8000/api/*
handle /api/* {
    reverse_proxy cognee:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # WebSocket 支持
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}
        
        # 超时设置
        transport http {
            dial_timeout 60s
            response_header_timeout 60s
        }
    }
}

# Cognee 健康检查
handle /health {
    reverse_proxy cognee:8000
}

# ==================== Cognee MCP API Mode ====================
# 路径: /mcp-api/* -> cognee-mcp-api:8000/* (去除 /mcp-api/ 前缀)
handle_path /mcp-api/* {
    reverse_proxy cognee-mcp-api:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # SSE 支持（Server-Sent Events）
        header_up Connection ""
        header_up Cache-Control "no-cache"
        
        # 超时设置（SSE 需要长连接）
        transport http {
            dial_timeout 300s
            response_header_timeout 300s
        }
    }
}

# MCP API 健康检查（去除 /mcp-api/ 前缀）
handle /mcp-api/health {
    rewrite * /health
    reverse_proxy cognee-mcp-api:8000
}

# ==================== Cognee MCP Direct Mode ====================
# 路径: /mcp-direct/* -> cognee-mcp-direct:8000/* (去除 /mcp-direct/ 前缀)
handle_path /mcp-direct/* {
    reverse_proxy cognee-mcp-direct:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        # SSE 支持（Server-Sent Events）
        header_up Connection ""
        header_up Cache-Control "no-cache"
        
        # 超时设置（SSE 需要长连接）
        transport http {
            dial_timeout 300s
            response_header_timeout 300s
        }
    }
}

# MCP Direct 健康检查（去除 /mcp-direct/ 前缀）
handle /mcp-direct/health {
    rewrite * /health
    reverse_proxy cognee-mcp-direct:8000
}

# ==================== 默认路由 ====================
# 根路径返回服务信息
handle {
    respond '{"status": "ok", "service": "caddy-reverse-proxy", "endpoints": {"/api": "Cognee API", "/mcp-api": "Cognee MCP API Mode", "/mcp-direct": "Cognee MCP Direct Mode"}}' 200 {
        header Content-Type "application/json"
    }
}

