# Nginx 反向代理配置
# 统一后端服务，避免 CORS 问题

upstream cognee_backend {
    server cognee:8000 max_fails=3 fail_timeout=30s;
    # 可以添加多个后端实现负载均衡
    # server cognee2:8000 backup;
}

upstream cognee_mcp_api {
    server cognee-mcp-api:8000 max_fails=3 fail_timeout=30s;
}

upstream cognee_mcp_direct {
    server cognee-mcp-direct:8000 max_fails=3 fail_timeout=30s;
}

# 使用变量延迟解析，避免启动时无法解析 Docker 服务名
# resolver 127.0.0.11 valid=30s;
# 注意：如果使用变量，需要在 location 块中使用变量而不是 upstream

# 日志格式配置（必须在 http 块中，不能在 server 块中）
# 详细日志格式（包含上游响应时间）
log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   'rt=$request_time uct="$upstream_connect_time" '
                   'uht="$upstream_header_time" urt="$upstream_response_time"';

server {
    listen 80;
    server_name _;
    
    # 使用 Docker 内置 DNS 解析器（127.0.0.11）
    # 这样可以在运行时解析服务名称，而不是在配置解析时
    resolver 127.0.0.11 valid=30s;
    resolver_timeout 5s;

    # 客户端请求体大小限制
    client_max_body_size 100M;

    # 日志配置
    access_log /var/log/nginx/access.log detailed;
    error_log /var/log/nginx/error.log warn;

    # ==================== CORS 配置 ====================
    # 统一添加 CORS 头，允许前端跨域访问
    # 动态设置 CORS Origin（当使用 credentials: 'include' 时，不能使用通配符 *）
    set $cors_origin "";
    if ($http_origin ~* "^https?://(localhost|127\.0\.0\.1|192\.168\.\d+\.\d+)(:\d+)?$") {
        set $cors_origin $http_origin;
    }
    if ($cors_origin = "") {
        set $cors_origin "*";
    }

    # ==================== Cognee 主 API ====================
    # 路径: /api/* -> cognee:8000/api/* (保留完整路径，因为后端路由是 /api/v1/*)
    # 前端配置 NEXT_PUBLIC_BACKEND_API_URL=http://192.168.66.11:8080 (不包含 /api)
    # 前端代码会构建 /api/v1/* 路径，nginx 直接转发到后端
    #
    # 注意：精确匹配优先级最高，然后是前缀匹配
    
    # FastAPI 文档路径映射：/api/docs -> /docs (直接代理，不重定向)
    location = /api/docs {
        rewrite ^/api/docs$ /docs break;
        proxy_pass http://cognee_backend;
        proxy_http_version 1.1;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location = /api/redoc {
        rewrite ^/api/redoc$ /redoc break;
        proxy_pass http://cognee_backend;
        proxy_http_version 1.1;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # OpenAPI JSON 规范文件
    # Swagger UI 会从根路径请求 /openapi.json（当访问 /api/docs 时）
    location = /openapi.json {
        proxy_pass http://cognee_backend/openapi.json;
        proxy_http_version 1.1;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # OpenAPI JSON 规范文件（通过 /api/openapi.json 访问）
    location = /api/openapi.json {
        rewrite ^/api/openapi.json$ /openapi.json break;
        proxy_pass http://cognee_backend;
        proxy_http_version 1.1;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 正常路径：/api/* -> cognee:8000/api/* (包括 /api/v1/* 等)
    location /api/ {
        # 处理 OPTIONS 预检请求（CORS 预检）
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $cors_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Max-Age 1728000 always;
            add_header Content-Type "text/plain charset=UTF-8" always;
            add_header Content-Length 0 always;
            return 204;
        }
        
        proxy_pass http://cognee_backend;
        proxy_http_version 1.1;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # 请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Cognee 健康检查
    location /health {
        proxy_pass http://cognee_backend;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Cognee 详细健康检查
    location /health/detailed {
        proxy_pass http://cognee_backend;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ==================== Cognee MCP API Mode ====================
    # 路径: /mcp-api/* -> cognee-mcp-api:8000/*
    location /mcp-api/ {
        proxy_pass http://cognee_mcp_api/;
        proxy_http_version 1.1;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # 请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE 支持（Server-Sent Events）
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection '';
        chunked_transfer_encoding off;
        
        # 超时设置（SSE 需要长连接）
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # MCP API 健康检查
    location /mcp-api/health {
        proxy_pass http://cognee_mcp_api/health;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ==================== Cognee MCP Direct Mode ====================
    # 路径: /mcp-direct/* -> cognee-mcp-direct:8000/*
    location /mcp-direct/ {
        proxy_pass http://cognee_mcp_direct/;
        proxy_http_version 1.1;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        # 请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE 支持（Server-Sent Events）
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection '';
        chunked_transfer_encoding off;
        
        # 超时设置（SSE 需要长连接）
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # MCP Direct 健康检查
    location /mcp-direct/health {
        proxy_pass http://cognee_mcp_direct/health;
        
        # 隐藏后端返回的 CORS 头，避免重复
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Credentials;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ==================== 前端服务 ====================
    # 路径: / -> cognee-frontend:3000
    # 注意：这个 location 必须在最后，因为 Nginx 按优先级匹配
    # 精确匹配和前缀匹配（/api/, /mcp-api/）会优先于这个通用匹配
    # 使用变量延迟解析，避免启动时无法解析 Docker 服务名
    location / {
        set $frontend_upstream "http://cognee-frontend:3000";
        proxy_pass $frontend_upstream;
        proxy_http_version 1.1;
        
        # 请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持（Next.js 可能需要）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Next.js 特定配置
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲设置（Next.js 服务端渲染需要）
        proxy_buffering off;
        proxy_cache off;
    }
}

