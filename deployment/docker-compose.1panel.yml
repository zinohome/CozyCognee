# 1Panel Docker Compose 编排文件
# 适用于1Panel面板的Docker Compose配置
# 注意：使用外部网络 1panel-network，所有数据存储在 /data/cognee 目录

services:
  # Cognee 主应用服务
  cognee:
    image: cognee:latest
    container_name: cognee
    restart: unless-stopped
    ports:
      - "8000:8000"
    # 内存限制（如果 1Panel 支持）
    mem_limit: 2g
    mem_reservation: 512m
    environment:
      # ==================== 基础配置 ====================
      - DEBUG=false
      - ENVIRONMENT=production
      - LOG_LEVEL=ERROR
      - HOST=0.0.0.0
      - HTTP_PORT=8000
      - PYTHONUNBUFFERED=1
      # ==================== LLM 配置 ====================
      # 必需：配置您的LLM API密钥
      - LLM_API_KEY=your-llm-api-key-here
      - LLM_PROVIDER=openai  # 可选: openai, anthropic, groq, ollama, mistral
      - LLM_MODEL=gpt-4o-mini  # 根据provider选择模型
      - LLM_ENDPOINT=https://oneapi.naivehero.top/v1
      - LLM_MAX_TOKENS=16384
      # ==================== 数据库配置 ====================
      # 关系型数据库配置 (标准 PostgreSQL - postgres 服务)
      - DATABASE_URL=postgresql://cognee_user:cognee_password@postgres:5432/cognee_db
      - DB_PROVIDER=postgres
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=cognee_db
      - DB_USERNAME=cognee_user
      - DB_PASSWORD=cognee_password
      # ==================== 向量数据库配置 ====================
      # 使用 pgvector (独立的 pgvector 服务)
      # 注意: 使用 pgvector 时，向量数据存储在 PostgreSQL 中，无需 VECTOR_DB_URL 和 VECTOR_DB_KEY
      - VECTOR_DB_PROVIDER=pgvector
      # 如果使用其他向量数据库，需要配置相应的 URL 和 KEY
      # ==================== 图数据库配置 ====================
      - GRAPH_DATABASE_PROVIDER=neo4j  # 可选: kuzu, neo4j
      - NEO4J_URL=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=pleaseletmein
      # ==================== Redis 配置 ====================
      - REDIS_URL=redis://:cognee_redis_password@redis:6379/0
      # ==================== 对象存储配置 (MinIO/S3) ====================
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET_NAME=cognee-storage
      - S3_USE_SSL=false
      # ==================== CORS 配置 ====================
      # 允许的跨域来源（逗号分隔）
      # 注意：使用 credentials: "include" 时，不能使用 "*" 通配符
      # 必须明确列出所有允许的源
      - CORS_ALLOWED_ORIGINS=http://192.168.99.100:3000,http://192.168.66.11:3000,http://localhost:3000,http://127.0.0.1:3000,http://192.168.66.11:8000,http://localhost:8000,http://127.0.0.1:8000
      # ==================== 其他配置 ====================
      # 可选依赖
      - EXTRAS=api,postgres,neo4j
      - TELEMETRY_DISABLED=1
      - DEFAULT_USER_EMAIL=admin@cognee.com
      - DEFAULT_USER_PASSWORD=passw0rd
    depends_on:
      postgres:
        condition: service_healthy
      pgvector:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_started
    volumes:
      - /data/cognee/data:/app/data
      - /data/cognee/logs:/app/logs
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Cognee MCP 服务（可选）
  # 注意：cognee-mcp 有两种运行模式：
  # 1. Direct Mode（直接模式）：直接使用 cognee 库，需要所有 cognee 的环境变量
  #    使用镜像: cognee-mcp:latest (约 8.5GB，包含完整依赖)
  # 2. API Mode（API 模式）：连接到 cognee API 服务器，只需要 API_URL
  #    使用镜像: cognee-mcp:api-latest (约 2-3GB，轻量级，推荐)
  # 
  # 当前配置为 API Mode（轻量级），如需 Direct Mode，请：
  # 1. 将 image 改为 cognee-mcp:latest
  # 2. 取消注释下面的 LLM 和数据库配置
  # 3. 注释掉 API_URL 配置
  cognee-mcp:
    image: cognee-mcp:api-latest  # 使用轻量级 API Mode 镜像
    container_name: cognee-mcp
    restart: unless-stopped
    profiles:
      - mcp
    ports:
      - "8001:8000"
    environment:
      # ==================== 基础配置 ====================
      - DEBUG=false
      - ENVIRONMENT=production
      - PYTHONUNBUFFERED=1
      # ==================== MCP 配置 ====================
      - TRANSPORT_MODE=sse  # 可选: stdio, sse, http
      - MCP_LOG_LEVEL=INFO
      # ==================== API Mode 配置 ====================
      # API Mode 下只需要配置 API URL，不需要 LLM、数据库等配置
      - API_URL=http://cognee:8000
      # - API_TOKEN=your-api-token  # 如果 API 启用了认证，取消注释并设置
      # ==================== Direct Mode 配置（已注释，API Mode 不需要）====================
      # 如果使用 Direct Mode（cognee-mcp:latest），取消注释以下配置并注释掉 API_URL
      # - LOG_LEVEL=ERROR
      # - LLM_API_KEY=your-llm-api-key-here
      # - LLM_PROVIDER=openai
      # - LLM_MODEL=gpt-4o-mini
      # - LLM_ENDPOINT=https://oneapi.naivehero.top/v1
      # - LLM_MAX_TOKENS=16384
      # - DATABASE_URL=postgresql://cognee_user:cognee_password@postgres:5432/cognee_db
      # - DB_PROVIDER=postgres
      # - DB_HOST=postgres
      # - DB_PORT=5432
      # - DB_NAME=cognee_db
      # - DB_USERNAME=cognee_user
      # - DB_PASSWORD=cognee_password
      # - VECTOR_DB_PROVIDER=pgvector
      # - GRAPH_DATABASE_PROVIDER=neo4j
      # - NEO4J_URL=bolt://neo4j:7687
      # - NEO4J_USER=neo4j
      # - NEO4J_PASSWORD=pleaseletmein
      # - REDIS_URL=redis://:cognee_redis_password@redis:6379/0
      # - S3_ENDPOINT=http://minio:9000
      # - S3_ACCESS_KEY=minioadmin
      # - S3_SECRET_KEY=minioadmin
      # - S3_BUCKET_NAME=cognee-storage
      # - S3_USE_SSL=false
      # - EXTRAS=api,postgres,neo4j
      # - TELEMETRY_DISABLED=1
    depends_on:
      cognee:
        condition: service_healthy
      # API Mode 下不需要直接依赖 postgres（通过 cognee API 访问）
      # postgres:
      #   condition: service_healthy
    volumes:
      - /data/cognee/mcp:/app/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Cognee 前端服务（可选）
  frontend:
    image: cognee-frontend:latest
    container_name: cognee-frontend
    restart: unless-stopped
    profiles:
      - ui
    ports:
      - "3000:3000"
    environment:
      # 运行时环境变量（会覆盖构建时的默认值）
      # 注意：NEXT_PUBLIC_* 变量在开发模式下可以在运行时修改
      - NEXT_PUBLIC_BACKEND_API_URL=http://192.168.66.11:8000
      - NEXT_PUBLIC_CLOUD_API_URL=http://192.168.66.11:8001
      - NEXT_PUBLIC_MCP_API_URL=http://192.168.66.11:8001
      - NEXT_PUBLIC_COGWIT_API_KEY=
      - NEXT_PUBLIC_IS_CLOUD_ENVIRONMENT=false
    depends_on:
      cognee:
        condition: service_healthy
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL 关系数据库
  postgres:
    image: postgres:15-alpine
    container_name: cognee_postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=cognee_user
      - POSTGRES_PASSWORD=cognee_password
      - POSTGRES_DB=cognee_db
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - /data/cognee/postgres:/var/lib/postgresql/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cognee_user -d cognee_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgvector 向量数据库（独立的 PostgreSQL 实例，带 pgvector 扩展）
  pgvector:
    image: pgvector/pgvector:0.8.1-pg17-trixie
    container_name: cognee_pgvector
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=cognee_vector_user
      - POSTGRES_PASSWORD=cognee_vector_password
      - POSTGRES_DB=cognee_vector_db
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - /data/cognee/pgvector:/var/lib/postgresql/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cognee_vector_user -d cognee_vector_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存和消息队列
  redis:
    image: redis:7-alpine
    container_name: cognee_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass cognee_redis_password
    environment:
      - REDIS_PASSWORD=cognee_redis_password
    volumes:
      - /data/cognee/redis:/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "cognee_redis_password", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # MinIO 对象存储 (S3 兼容)
  # 使用 cpuv1 版本以兼容不支持 x86-64-v2 的旧 CPU
  minio:
    image: quay.io/minio/minio:RELEASE.2023-11-01T01-57-10Z-cpuv1
    container_name: cognee_minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - /data/cognee/minio:/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    # MinIO 容器可能没有 ps/grep 等工具，使用 service_started 代替健康检查
    # 如果需要健康检查，可以安装 curl 或使用其他方法

  # Neo4j 图数据库
  neo4j:
    image: neo4j:latest
    container_name: cognee_neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/pleaseletmein
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - /data/cognee/neo4j/data:/data
      - /data/cognee/neo4j/logs:/logs
      - /data/cognee/neo4j/import:/var/lib/neo4j/import
      - /data/cognee/neo4j/plugins:/plugins
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "pleaseletmein", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Insight 管理工具
  redisinsight:
    image: redislabs/redisinsight:latest
    container_name: cognee_redisinsight
    restart: unless-stopped
    user: "0:0"  # 以 root 用户运行
    ports:
      - "5540:5540"
    volumes:
      - /data/cognee/redisinsight:/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5540"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Redis Insight 可以通过 Web UI 连接到 redis 服务
    # 连接信息: redis://:cognee_redis_password@redis:6379/0

networks:
  1panel-network:
    external: true
