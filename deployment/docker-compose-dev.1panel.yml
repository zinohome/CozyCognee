# 1Panel Docker Compose 编排文件
# 适用于1Panel面板的Docker Compose配置
# 注意：使用外部网络 1panel-network，所有数据存储在 /data/cognee 目录

services:
  # PostgreSQL 关系数据库
  postgres:
    image: postgres:15-alpine
    container_name: cognee_postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=cognee_user
      - POSTGRES_PASSWORD=cognee_password
      - POSTGRES_DB=cognee_db
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - /data/cognee/postgres:/var/lib/postgresql/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cognee_user -d cognee_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgvector 向量数据库（独立的 PostgreSQL 实例，带 pgvector 扩展）
  pgvector:
    image: pgvector/pgvector:0.8.1-pg17-trixie
    container_name: cognee_pgvector
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=cognee_vector_user
      - POSTGRES_PASSWORD=cognee_vector_password
      - POSTGRES_DB=cognee_vector_db
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - /data/cognee/pgvector:/var/lib/postgresql/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cognee_vector_user -d cognee_vector_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存和消息队列
  redis:
    image: redis:7-alpine
    container_name: cognee_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass cognee_redis_password
    environment:
      - REDIS_PASSWORD=cognee_redis_password
    volumes:
      - /data/cognee/redis:/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "cognee_redis_password", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # MinIO 对象存储 (S3 兼容)
  # 使用 cpuv1 版本以兼容不支持 x86-64-v2 的旧 CPU
  minio:
    image: quay.io/minio/minio:RELEASE.2023-11-01T01-57-10Z-cpuv1
    container_name: cognee_minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - /data/cognee/minio:/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    # MinIO 容器可能没有 ps/grep 等工具，使用 service_started 代替健康检查
    # 如果需要健康检查，可以安装 curl 或使用其他方法

  # Neo4j 图数据库
  neo4j:
    image: neo4j:latest
    container_name: cognee_neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/pleaseletmein
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - /data/cognee/neo4j/data:/data
      - /data/cognee/neo4j/logs:/logs
      - /data/cognee/neo4j/import:/var/lib/neo4j/import
      - /data/cognee/neo4j/plugins:/plugins
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "pleaseletmein", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Insight 管理工具
  redisinsight:
    image: redislabs/redisinsight:latest
    container_name: cognee_redisinsight
    restart: unless-stopped
    user: "0:0"  # 以 root 用户运行
    ports:
      - "5540:5540"
    volumes:
      - /data/cognee/redisinsight:/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5540"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Redis Insight 可以通过 Web UI 连接到 redis 服务
    # 连接信息: redis://:cognee_redis_password@redis:6379/0

networks:
  1panel-network:
    external: true
